Imports System.Web.Services
Imports System.Xml.Serialization
Imports System.Collections.Generic

<Serializable(), XmlInclude(GetType(Exploitation))>
Public Class Exploitation
    Inherits root

    Private _uidstructure As Integer
    Private _numeroSiren As String = ""
    Private _codeApe As String = ""
    Private _raisonSociale As String = ""
    Private _nombreExploitant As Integer
    Private _nomExploitant As String = ""
    Private _prenomExploitant As String = ""
    Private _adresse As String = ""
    Private _codePostal As String = ""
    Private _commune As String = ""
    Private _codeInsee As String = ""
    Private _telephoneFixe As String = ""
    Private _telephonePortable As String = ""
    Private _telephoneFax As String = ""
    Private _eMail As String = ""
    Private _isProdGrandeCulture As Boolean
    Private _isProdElevage As Boolean
    Private _isProdArboriculture As Boolean
    Private _isProdLegume As Boolean
    Private _isProdViticulture As Boolean
    Private _isProdAutre As Boolean
    Private _productionAutre As String = ""
    Private _isSupprime As Boolean
    Private _dateDernierControle As String = ""
    Private _surfaceAgricoleUtile As String = ""
    Private _nPulvesArlerte As Integer
    Private _dateProchainControle As String = ""

    Private _lstPulveimport As List(Of Pulverisateur)
    <XmlIgnore()>
    Public ReadOnly Property lstPulveImport() As List(Of Pulverisateur)
        Get
            Return _lstPulveimport
        End Get
    End Property
    Private _lstDiagImport As List(Of Diagnostic)
    <XmlIgnore()>
    Public ReadOnly Property lstDiagImport() As List(Of Diagnostic)
        Get
            Return _lstDiagImport
        End Get
    End Property

    Sub New()
        numeroSiren = ""
        _nPulvesArlerte = 0
        _lstPulveimport = New List(Of Pulverisateur)()
        _lstDiagImport = New List(Of Diagnostic)()
        isSuppressionCoprop = False
        Fact = ""
    End Sub

    Public Property id() As String
        Get
            Return aid
        End Get
        Set(ByVal Value As String)
            aid = Value
        End Set
    End Property
    Public Property idStructure() As Integer
        Get
            Return uidstructure
        End Get
        Set(ByVal Value As Integer)
            uidstructure = Value
        End Set
    End Property
    Public Property uidstructure() As Integer
        Get
            Return _uidstructure
        End Get
        Set(ByVal Value As Integer)
            _uidstructure = Value
        End Set
    End Property

    Public Property numeroSiren() As String
        Get
            Return _numeroSiren
        End Get
        Set(ByVal Value As String)
            _numeroSiren = Value
        End Set
    End Property

    Public Property codeApe() As String
        Get
            Return _codeApe
        End Get
        Set(ByVal Value As String)
            _codeApe = Value
        End Set
    End Property

    Public Property raisonSociale() As String
        Get
            Return _raisonSociale
        End Get
        Set(ByVal Value As String)
            _raisonSociale = Value
        End Set
    End Property

    Public Property nombreExploitant() As Integer
        Get
            Return _nombreExploitant
        End Get
        Set(ByVal Value As Integer)
            _nombreExploitant = Value
        End Set
    End Property

    Public Property nomExploitant() As String
        Get
            Return _nomExploitant
        End Get
        Set(ByVal Value As String)
            _nomExploitant = Value
        End Set
    End Property

    Public Property prenomExploitant() As String
        Get
            Return _prenomExploitant
        End Get
        Set(ByVal Value As String)
            _prenomExploitant = Value
        End Set
    End Property

    Public Property adresse() As String
        Get
            Return _adresse
        End Get
        Set(ByVal Value As String)
            _adresse = Value
        End Set
    End Property

    Public Property codePostal() As String
        Get
            Return _codePostal
        End Get
        Set(ByVal Value As String)
            _codePostal = Value
        End Set
    End Property

    Public Property commune() As String
        Get
            Return _commune
        End Get
        Set(ByVal Value As String)
            _commune = Value
        End Set
    End Property

    Public Property codeInsee() As String
        Get
            Return _codeInsee
        End Get
        Set(ByVal Value As String)
            _codeInsee = Value
        End Set
    End Property

    Public Property telephoneFixe() As String
        Get
            Return _telephoneFixe
        End Get
        Set(ByVal Value As String)
            _telephoneFixe = Value
        End Set
    End Property

    Public Property telephonePortable() As String
        Get
            Return _telephonePortable
        End Get
        Set(ByVal Value As String)
            _telephonePortable = Value
        End Set
    End Property

    Public Property telephoneFax() As String
        Get
            Return _telephoneFax
        End Get
        Set(ByVal Value As String)
            _telephoneFax = Value
        End Set
    End Property

    Public Property eMail() As String
        Get
            Return _eMail
        End Get
        Set(ByVal Value As String)
            _eMail = Value
        End Set
    End Property

    Public Property isProdGrandeCulture() As Boolean
        Get
            Return _isProdGrandeCulture
        End Get
        Set(ByVal Value As Boolean)
            _isProdGrandeCulture = Value
        End Set
    End Property

    Public Property isProdElevage() As Boolean
        Get
            Return _isProdElevage
        End Get
        Set(ByVal Value As Boolean)
            _isProdElevage = Value
        End Set
    End Property

    Public Property isProdArboriculture() As Boolean
        Get
            Return _isProdArboriculture
        End Get
        Set(ByVal Value As Boolean)
            _isProdArboriculture = Value
        End Set
    End Property

    Public Property isProdLegume() As Boolean
        Get
            Return _isProdLegume
        End Get
        Set(ByVal Value As Boolean)
            _isProdLegume = Value
        End Set
    End Property

    Public Property isProdViticulture() As Boolean
        Get
            Return _isProdViticulture
        End Get
        Set(ByVal Value As Boolean)
            _isProdViticulture = Value
        End Set
    End Property

    Public Property isProdAutre() As Boolean
        Get
            Return _isProdAutre
        End Get
        Set(ByVal Value As Boolean)
            _isProdAutre = Value
        End Set
    End Property

    Public Property productionAutre() As String
        Get
            Return _productionAutre
        End Get
        Set(ByVal Value As String)
            _productionAutre = Value
        End Set
    End Property

    Public Property isSupprime() As Boolean
        Get
            Return _isSupprime
        End Get
        Set(ByVal Value As Boolean)
            _isSupprime = Value
        End Set
    End Property
    <XmlIgnoreAttribute()>
    Public Property dateDernierControle() As String
        Get
            Return _dateDernierControle
        End Get
        Set(ByVal Value As String)
            _dateDernierControle = Value
        End Set
    End Property
    <XmlElement("dateDernierControle")>
    Public Property dateDernierControleWS() As String
        Get
            If String.IsNullOrEmpty(_dateDernierControle) Then
                Return ""
            Else
                Return CSDate.GetDateForWS(_dateDernierControle)
            End If
        End Get
        Set(ByVal Value As String)
        End Set
    End Property
    <XmlIgnoreAttribute()>
    Public Property dateProchainControle() As String
        Get
            Return _dateProchainControle
        End Get
        Set(ByVal Value As String)
            _dateProchainControle = Value
        End Set
    End Property
    'Public Function ShouldSerializedateDernierControle() As Boolean
    '    Return Not String.IsNullOrEmpty(_dateDernierControle)
    'End Function
    'Public Function ShouldSerializedateDernierControleWS() As Boolean
    '    Return Not String.IsNullOrEmpty(_dateDernierControle)
    'End Function    
    <XmlElement("sau")>
    Public Property surfaceAgricoleUtile() As String
        Get
            Return _surfaceAgricoleUtile
        End Get
        Set(ByVal Value As String)
            _surfaceAgricoleUtile = Value
        End Set
    End Property

    <XmlIgnoreAttribute()>
    Public Property nPulvesAlerte() As Integer
        Get
            Return _nPulvesArlerte
        End Get
        Set(ByVal Value As Integer)
            _nPulvesArlerte = Value
        End Set
    End Property

    Public Function ExportCSV(pAgent As Agent, pFile As String, pbentete As Boolean) As Boolean
        If pbentete Then
            ExportCSVentete(pFile)
        End If
        Dim oSW As System.IO.StreamWriter
        oSW = System.IO.File.AppendText(pFile)

        Dim strLine As String
        Dim strLineExploit As String
        strLineExploit = ""
        strLineExploit = strLineExploit & numeroSiren
        strLineExploit = strLineExploit & ";" & codeApe
        strLineExploit = strLineExploit & ";" & raisonSociale
        strLineExploit = strLineExploit & ";" & nombreExploitant
        strLineExploit = strLineExploit & ";" & nomExploitant
        strLineExploit = strLineExploit & ";" & prenomExploitant
        strLineExploit = strLineExploit & ";" & adresse
        strLineExploit = strLineExploit & ";" & codePostal
        strLineExploit = strLineExploit & ";" & commune
        strLineExploit = strLineExploit & ";" & codeInsee
        strLineExploit = strLineExploit & ";" & telephoneFixe
        strLineExploit = strLineExploit & ";" & telephonePortable
        strLineExploit = strLineExploit & ";" & telephoneFax
        strLineExploit = strLineExploit & ";" & eMail
        strLineExploit = strLineExploit & ";" & isProdGrandeCulture
        strLineExploit = strLineExploit & ";" & isProdElevage
        strLineExploit = strLineExploit & ";" & isProdArboriculture
        strLineExploit = strLineExploit & ";" & isProdLegume
        strLineExploit = strLineExploit & ";" & isProdViticulture
        strLineExploit = strLineExploit & ";" & isProdAutre
        strLineExploit = strLineExploit & ";" & productionAutre
        strLineExploit = strLineExploit & ";" & dateDernierControle
        strLineExploit = strLineExploit & ";" & surfaceAgricoleUtile

        Dim tabPulve As Pulverisateur() = PulverisateurManager.getPulverisateurByClientId(Me.id, pAgent.DroitsPulves)
        If tabPulve.Length > 0 Then
            For Each oPulve As Pulverisateur In tabPulve
                strLine = strLineExploit
                strLine = strLine + ";" + oPulve.id
                strLine = strLine + ";" + oPulve.numeroNational
                Dim lstdiag As Generic.List(Of Diagnostic)
                lstdiag = DiagnosticManager.getlstDiagnosticByPulveId(oPulve.id)
                If lstdiag.Count > 0 Then
                    'Les Diag sont triés pas date de controle desc, on prend donc uniquement le premier
                    Dim oDiag As Diagnostic = lstdiag(0)
                    strLine = strLine + ";" + oDiag.id
                    strLine = strLine + ";" + oDiag.controleDateDebut
                    strLine = strLine + ";" + oDiag.controleLieu
                    strLine = strLine + ";" + oDiag.controleSite
                    strLine = strLine + ";" + oDiag.controleNomSite
                    strLine = strLine + ";" + oDiag.controleEtat
                    strLine = strLine + ";" + oDiag.controleTarif
                Else
                    'Pas de Diagnostic
                    strLine = strLine + ";" '+ oDiag.id
                    strLine = strLine + ";" '+ oDiag.controleDateDebut
                    strLine = strLine + ";" '+ oDiag.controleLieu
                    strLine = strLine + ";" '+ oDiag.controleSite
                    strLine = strLine + ";" '+ oDiag.controleNomSite
                    strLine = strLine + ";" '+ oDiag.controleEtat
                    strLine = strLine + ";" '+ oDiag.controleTarif

                End If
                oSW.WriteLine(strLine)
            Next
        Else
            'Pas de pulvé
            strLine = strLineExploit
            strLine = strLine + ";" '+ oPulve.id
            strLine = strLine + ";" '+ oPulve.numeroNational
            strLine = strLine + ";" '+ oDiag.id
            strLine = strLine + ";" '+ oDiag.controleDateDebut
            strLine = strLine + ";" '+ oDiag.controleLieu
            strLine = strLine + ";" '+ oDiag.controleSite
            strLine = strLine + ";" '+ oDiag.controleNomSite
            strLine = strLine + ";" '+ oDiag.controleEtat
            strLine = strLine + ";" '+ oDiag.controleTarif
            oSW.WriteLine(strLine)
        End If

        oSW.Close()

    End Function
    Public Function ExportCSVentete(ByVal pFilename As String) As Boolean

        ' On supprime le fichier s'il existe
        If System.IO.File.Exists(pFilename) Then
            System.IO.File.Delete(pFilename)
        End If

        Dim strLine As String
        strLine = ""
        strLine = strLine + "numeroSiren"
        strLine = strLine + ";CodeAPE"
        strLine = strLine + ";raisonSociale"
        strLine = strLine + ";nombreExploitant"
        strLine = strLine + ";nomExploitant"
        strLine = strLine + ";prenomExploitant"
        strLine = strLine + ";adresse"
        strLine = strLine + ";codePostal"
        strLine = strLine + ";Commune"
        strLine = strLine + ";codeInsee"
        strLine = strLine + ";telephoneFixe"
        strLine = strLine + ";telephonePortable"
        strLine = strLine + ";telephoneFax"
        strLine = strLine + ";eMail"
        strLine = strLine + ";isProdGrandeCulture"
        strLine = strLine + ";isProdElevage"
        strLine = strLine + ";isProdArboriculture"
        strLine = strLine + ";isProdLegume"
        strLine = strLine + ";isProdViticulture"
        strLine = strLine + ";isProdAutre"
        strLine = strLine + ";productionAutre"
        strLine = strLine + ";dateDernierControle"
        strLine = strLine + ";surfaceAgricoleUtile"
        strLine = strLine + ";PulveID"
        strLine = strLine + ";numeroNational"
        strLine = strLine + ";NumDiag"
        strLine = strLine + ";controleDateDebut"
        strLine = strLine + ";controleLieu"
        strLine = strLine + ";controleSite"
        strLine = strLine + ";controleNomSite"
        strLine = strLine + ";controleEtat"
        strLine = strLine + ";controleTarif"

        Dim oSW As System.IO.StreamWriter = System.IO.File.AppendText(pFilename)
        oSW.WriteLine(strLine)
        oSW.Close()


    End Function
    Private _SupprCoprop As Boolean
    ''' <summary>
    ''' Cette propriété ne sert que dans la gestion de co-pro Temporairement
    ''' </summary>
    ''' <returns></returns>
    <XmlIgnore()>
    Public Property isSuppressionCoprop() As Boolean
        Get
            Return _SupprCoprop
        End Get
        Set(ByVal value As Boolean)
            _SupprCoprop = value
        End Set
    End Property
    ''' <summary>
    ''' Exploitant facturé (utilisé uniquement en Création de facture)
    ''' </summary>
    <XmlIgnore()>
    Private _bFact As String
    Public Property Fact() As String
        Get
            Return _bFact
        End Get
        Set(ByVal value As String)
            _bFact = value
        End Set
    End Property

    Public Overrides Function Fill(pColName As String, pColValue As Object) As Boolean
        Dim bReturn As Boolean
        Try
            bReturn = MyBase.Fill(pColName, pColValue)
            If Not bReturn Then
                bReturn = True
                Select Case pColName.Trim().ToUpper
                    Case "id".Trim().ToUpper()
                        Me.id = pColValue.ToString()
                    Case "numeroSiren".Trim().ToUpper()
                        Me.numeroSiren = pColValue.ToString()
                    Case "codeApe".Trim().ToUpper()
                        Me.codeApe = pColValue.ToString()
                    Case "raisonSociale".Trim().ToUpper()
                        Me.raisonSociale = pColValue.ToString()
                    Case "nombreExploitant".Trim().ToUpper()
                        Me.nombreExploitant = pColValue
                    Case "nomExploitant".Trim().ToUpper()
                        Me.nomExploitant = pColValue.ToString()
                    Case "prenomExploitant".Trim().ToUpper()
                        Me.prenomExploitant = pColValue.ToString()
                    Case "adresse".Trim().ToUpper()
                        Me.adresse = pColValue.ToString()
                    Case "codePostal".Trim().ToUpper()
                        Me.codePostal = pColValue.ToString()
                    Case "commune".Trim().ToUpper()
                        Me.commune = pColValue.ToString()
                    Case "codeInsee".Trim().ToUpper()
                        Me.codeInsee = pColValue.ToString()
                    Case "telephoneFixe".Trim().ToUpper()
                        Me.telephoneFixe = pColValue.ToString()
                    Case "telephonePortable".Trim().ToUpper()
                        Me.telephonePortable = pColValue.ToString()
                    Case "telephoneFax".Trim().ToUpper()
                        Me.telephoneFax = pColValue.ToString()
                    Case "eMail".Trim().ToUpper()
                        Me.eMail = pColValue.ToString()
                    Case "isProdGrandeCulture".Trim().ToUpper()
                        Me.isProdGrandeCulture = pColValue.ToString()
                    Case "isProdElevage".Trim().ToUpper()
                        Me.isProdElevage = pColValue.ToString()
                    Case "isProdArboriculture".Trim().ToUpper()
                        Me.isProdArboriculture = pColValue.ToString()
                    Case "isProdLegume".Trim().ToUpper()
                        Me.isProdLegume = pColValue.ToString()
                    Case "isProdViticulture".Trim().ToUpper()
                        Me.isProdViticulture = pColValue.ToString()
                    Case "isProdAutre".Trim().ToUpper()
                        Me.isProdAutre = pColValue.ToString()
                    Case "productionAutre".Trim().ToUpper()
                        Me.productionAutre = pColValue.ToString()
                    Case "idStructure".Trim().ToUpper()
                        Me.idStructure = pColValue
                    Case "isSupprime".Trim().ToUpper()
                        Me.isSupprime = pColValue.ToString()
                    Case "dateDernierControle".Trim().ToUpper()
                        If String.IsNullOrEmpty(pColValue.ToString()) Or pColValue.ToString() = "30/12/1899 00:00:00" Then
                            Me.dateDernierControle = ""
                        Else
                            Me.dateDernierControle = CSDate.ToCRODIPString(pColValue.ToString())
                        End If
                    Case "surfaceAgricoleUtile".Trim().ToUpper()
                        Me.surfaceAgricoleUtile = pColValue.ToString()
                    Case "nPulvesAlerte".Trim().ToUpper()
                        Me.nPulvesAlerte = CInt(pColValue)
                    Case "DateProchainControle".Trim().ToUpper()
                        Me.dateProchainControle = CSDate.ToCRODIPString(pColValue)
                    Case "uidstructure".Trim().ToUpper()
                        Me.uidstructure = pColValue
                    Case Else
                        bReturn = False
                End Select
            End If
        Catch ex As Exception
            CSDebug.dispInfo("ExploitationManager.FillClient ERR " & ex.Message)
            bReturn = False
        End Try
        Return bReturn
    End Function




End Class