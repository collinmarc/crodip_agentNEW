Imports System.Collections.Generic
Imports System.Linq
Imports CRODIPWS

Public Class dlgGestionCoPro

    Private m_lstExploit As List(Of Exploitation)
    Private m_oAgent As Agent
    Private m_oPulverisateur As Pulverisateur

    Public Sub New()

        ' Cet appel est requis par le concepteur.
        InitializeComponent()

        ' Ajoutez une initialisation quelconque après l'appel InitializeComponent().
    End Sub

    Public Sub Setcontext(pPulve As Pulverisateur, pAgent As Agent)
        m_oPulverisateur = pPulve
        m_lstExploit = ExploitationManager.GetListExploitationByPulverisateurId(m_oPulverisateur.id)
        m_oAgent = pAgent

    End Sub
    Public Sub AjoutePropietaire(pExploit As Exploitation)
        m_lstExploit.Add(pExploit)
        m_bsrcExploitant.ResetBindings(False)
        m_bsrcExploitant.MoveLast()
    End Sub

    Private Sub FrmAddCoProp_Load(sender As Object, e As EventArgs) Handles Me.Load
        m_lstExploit.ForEach(Sub(oExploit)
                                 m_bsrcExploitant.Add(oExploit)
                             End Sub)
        m_dgvCoProp.Rows(m_dgvCoProp.Rows.Count - 1).Selected = True
    End Sub

    Private Sub btnNewExploitant_Click(sender As Object, e As EventArgs) Handles btnNewExploitant.Click
        CreerExploitant()
    End Sub

    Private Sub CreerExploitant()
        Dim frm As New fiche_exploitant()
        Dim OExploit As New Exploitation()
        OExploit.raisonSociale = "Nouveau."
        frm.setContexte(False, OExploit, m_oAgent, Nothing)
        If frm.ShowDialog() = DialogResult.OK Then
            m_lstExploit.Add(OExploit)
            m_bsrcExploitant.Add(OExploit)
        End If
        frm.Close()
    End Sub

    Private Sub btnAjoutExploitant_Click(sender As Object, e As EventArgs) Handles btnAjoutExploitant.Click
        Dim ofrm As New dlgListExploitant()
        ofrm.SetContexte(m_oAgent)
        If ofrm.ShowDialog() = DialogResult.OK Then
            If m_lstExploit.Where(Function(oExploit)
                                      Return oExploit.id = ofrm.oExploit.id
                                  End Function).Count() = 0 Then
                m_lstExploit.Add(ofrm.oExploit)
                m_bsrcExploitant.Add(ofrm.oExploit)
                m_bsrcExploitant.MoveLast()
            End If
        End If

    End Sub

    Private Sub btnSupprCoProp_Click(sender As Object, e As EventArgs) Handles btnSupprCoProp.Click
        SuppressionCoProp()
    End Sub

    Private Sub SuppressionCoProp()
        Dim m_oExploit As Exploitation
        If m_bsrcExploitant.Current IsNot Nothing Then
            m_oExploit = m_bsrcExploitant.Current
            m_oExploit.isSuppressionCoprop = True
            If m_dgvCoProp.CurrentRow IsNot Nothing Then
                m_dgvCoProp.Rows.Remove(m_dgvCoProp.CurrentRow)
            End If
        End If
    End Sub
    Private Sub btnValider_Click(sender As Object, e As EventArgs) Handles btnValider.Click
        SauvegarderExploitants()
        Me.DialogResult = DialogResult.OK
        Me.Close()
    End Sub
    Private Sub SauvegarderExploitants()
        'Sauvegarde des Exploitants
        m_lstExploit.ForEach(Sub(oExploit)
                                 ExploitationManager.save(oExploit, m_oAgent)
                                 ExploitationTOPulverisateurManager.save(m_oPulverisateur.id, oExploit.id, m_oPulverisateur.uid, oExploit.uid, oExploit.isSuppressionCoprop, m_oAgent)
                             End Sub)
    End Sub
    Public ReadOnly Property NbreExploitants() As Integer
        Get
            Return m_lstExploit.Count()
        End Get
    End Property
End Class